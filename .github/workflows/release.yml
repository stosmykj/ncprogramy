name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: write
  repository-projects: write

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest, ubuntu-22.04]

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Bun
        uses: oven-sh/setup-bun@v1

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libjavascriptcoregtk-4.1-dev \
            libsoup-3.0-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev

      - name: Install frontend dependencies
        run: bun install

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'ncprogramy v__VERSION__'
          releaseBody: 'See the assets to download and install this version.'
          releaseDraft: false
          prerelease: false
          includeUpdaterJson: true
          updaterJsonPreferNsis: true

  update-gist:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Download latest.json from release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          # Get the release assets
          ASSETS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG_NAME")

          # Find latest.json asset URL
          ASSET_URL=$(echo "$ASSETS" | jq -r '.assets[] | select(.name == "latest.json") | .url')

          if [ -z "$ASSET_URL" ] || [ "$ASSET_URL" == "null" ]; then
            echo "Error: latest.json not found in release assets"
            exit 1
          fi

          echo "Downloading latest.json from: $ASSET_URL"

          # Download the asset
          curl -L -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/octet-stream" \
            "$ASSET_URL" -o latest.json

          echo "Downloaded latest.json:"
          cat latest.json

      - name: Update Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          if [ -z "$GIST_TOKEN" ]; then
            echo "Error: GIST_TOKEN secret is not set"
            echo "Please create a GitHub Personal Access Token with 'gist' scope"
            echo "and add it as a secret named GIST_TOKEN"
            exit 1
          fi

          if [ -z "$GIST_ID" ]; then
            echo "Error: GIST_ID secret is not set"
            echo "Please create a Gist and add its ID as a secret named GIST_ID"
            exit 1
          fi

          # Read the latest.json content
          CONTENT=$(cat latest.json | jq -Rs .)

          # Update the Gist
          curl -X PATCH \
            -H "Authorization: token $GIST_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/gists/$GIST_ID" \
            -d "{
              \"files\": {
                \"latest.json\": {
                  \"content\": $CONTENT
                }
              }
            }"

          echo "âœ“ Gist updated successfully!"
          echo "URL: https://gist.githubusercontent.com/${{ github.repository_owner }}/$GIST_ID/raw/latest.json"
